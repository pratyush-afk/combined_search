import json

from agents.callback_logging import send_action_in_progress_to_caller
from config import Config
from fastapi.responses import HTMLResponse
from google.cloud import bigquery
from utilities.custom_logging import log

global project_id, textModelPath, embeddingsPath, embeddingsModelPath
textModelPath = ""
embeddingsPath = ""
embeddingsModelPath = ""
project_id = ""
ws_url = ""


class BigQueryClient:
    def __init__(self, project_id: str):
        self.client = bigquery.Client(project=project_id)
        self.project_id = project_id

    async def call_rag_model(self, query: str, userID: str):
        formatted_query = f"""
        SELECT
            base.content,
            base.uri,
            base.page_span_start,
            base.page_span_end
        FROM
        VECTOR_SEARCH(
        TABLE `{self.project_id}.{embeddingsPath}`,
        'ml_generate_embedding_result',
        (
            SELECT
            ml_generate_embedding_result,
            content AS query
            FROM
            ML.GENERATE_EMBEDDING(
                MODEL `{self.project_id}.{embeddingsModelPath}`,
                (
                    SELECT '{query}' AS content
                )
            )
        ),
        top_k => 10,
        options => '{{"fraction_lists_to_search":0.15}}'
         )
    """
        query_job = self.client.query(formatted_query)
        data = []

        for row in query_job:
            row_data = {field: row[field] for field in row.keys()}
            data.append(row_data)
        # Create a new list to hold the processed data
        processed_data = []
        log.info(f"Processing {len(data)} rows for user {userID}")
        send_action_in_progress_to_caller(f"Agent Found {len(data)} items", userID)
        # Loop through each item in the original data list
        for item in data:
            # Make a copy of the item to avoid modifying the original list in place
            new_item = item.copy()

            # Get the original URI
            uri = new_item.get("uri", "")

            # Check if the URI is a Google Cloud Storage URI and transform it
            if uri.startswith("gs://"):
                new_item["uri"] = uri.replace(
                    "gs://",
                    "https://dcsiq-app-dcsiq-genai-rag.apps.dev-03.us-central2.dev.sabre-gcp.com/content/",
                )

            # Add the updated item to our new list
            processed_data.append(new_item)

        uri_list = [item["uri"].replace(" ", "%20") for item in processed_data]
        # Remove duplicates while preserving order
        seen = set()
        unique_uri_list = []
        for uri in uri_list:
            if uri not in seen:
                unique_uri_list.append(uri)
                seen.add(uri)
        result = await self.call_bq(query)
        result_data = json.loads(result)
        values = [list(row.values())[0] for row in result_data]
        concatenated_result = "\n".join(values)
        grounding_support_text = (
            "<br><br><span style='color:blue;'><b>Grounding support:</b><br>"
            + "<br>".join(
                [
                    f"<a href='{uri}' target='_blank'>{uri.split('/')[-1].replace('%20', ' ')}</a>"
                    for uri in unique_uri_list
                ]
            )
            + "</span>"
        )
        final_response = concatenated_result + "\n" + grounding_support_text
        return final_response

    async def call_bq(self, query: str):
        log.info(f"Calling BQ RAG model with query: {query}")
        formatted_query = f"""
        SELECT
        ml_generate_text_llm_result AS generated
        FROM
        ML.GENERATE_TEXT(
            MODEL `{self.project_id}.{textModelPath}`,
            (
                SELECT
                CONCAT('{query}', ' ',
                STRING_AGG(FORMAT("context: %s and reference: %s", base.content, base.uri), ',')) AS prompt
                FROM
                VECTOR_SEARCH(
                    TABLE `{self.project_id}.{embeddingsPath}`,
                    'ml_generate_embedding_result',
                    (
                        SELECT
                        ml_generate_embedding_result,
                        content AS query
                        FROM
                        ML.GENERATE_EMBEDDING(
                            MODEL `{self.project_id}.{embeddingsModelPath}`,
                            (
                                SELECT '{query}' AS content
                            )
                        )
                    ),
                    top_k => 10,
                    OPTIONS => '{{"fraction_lists_to_search": 0.01}}'
                )
            ),
            STRUCT(10000 AS max_output_tokens, TRUE AS flatten_json_output)
        )
        """
        query_job = self.client.query(formatted_query)
        data = []
        for row in query_job:
            row_data = {field: row[field] for field in row.keys()}
            data.append(row_data)
        return json.dumps(data)


class DocumentEnhancement:
    def __init__(self, project_id: str, config: Config):
        self.bq_client = BigQueryClient(project_id)
        self.textModelPath = config.docSearch.textModelPath
        self.embeddingsPath = config.docSearch.embeddingsPath
        self.embeddingsModelPath = config.docSearch.embeddingsModelPath

    async def invoke_chain(self, query: str, userID: str):
        send_action_in_progress_to_caller(query, userID)
        result = await self.bq_client.call_rag_model(query, userID)
        log.debug(f"doc search text model path: {self.textModelPath}")
        log.debug(f"doc search embeddings path: {self.embeddingsPath}")
        log.debug(f"doc search embeddings model path: {self.embeddingsModelPath}")
        log.debug("Call BigQuery for document search")
        # result_data = json.loads(result)
        # values = [list(row.values())[0] for row in result_data]
        # concatenated_result = "\n".join(values)
        return HTMLResponse(content=result)


def init_project(cnf: Config):
    global project_id
    global textModelPath
    global embeddingsPath
    global embeddingsModelPath
    project_id = cnf.agent.project
    textModelPath = cnf.docSearch.textModelPath
    embeddingsPath = cnf.docSearch.embeddingsPath
    embeddingsModelPath = cnf.docSearch.embeddingsModelPath
